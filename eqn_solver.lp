% Armando Diaz Tolentino <ajdt@cs.washington.edu> 
% 
% This file encodes a solver for the equations
% generated by eqn_generator.lp
%
% NOTE: this file depends on eqn_rule for the rules used to solve an equation!
_step(1..max_steps).

_initially(Node, _field(active))					:-	_active(Node).
_initially(Node, _field(nodetype, Type)) 			:-	_nodeType(Node, Type).
_initially(Node, _field(nodeoper, Op)) 				:-	_nodeOper(Node, Op).
_initially(Node, _field(numchildren, ChildCount)) 	:-	_numChildren(Node, ChildCount).
_initially(Node, _field(monomof, monom(Coeff, Deg)))	:-	_monomOf(Node, Coeff, Deg).
_initially(Parent, _field(activechild, Child)) 		:-	_activeChild(Parent, Child).
_initially(Node, _field(numterms, NumTerms)) 		:-	_numTerms(Node, NumTerms).

_initially(Parent, _field(numer, Num))				:-	_numDenom(Parent, Num, Denom).
_initially(Parent, _field(denom, Denom))			:-	_numDenom(Parent, Num, Denom).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% FACTS BETWEEN STEPS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
_holds(Node, Field, 1)								:-	_initially(Node, Field).

_holds(Node, _field(FieldName, FieldValue), S+1) 	:-	_holds(Node, _field(FieldName, FieldValue), S),
														_step(S+1),
														not _remove(Node, FieldName, S).

_holds(Node, _field(FieldName, FieldValue), S+1) 	:-	_holds(Node, _field(FieldName, FieldValue), S),
														_step(S+1),
														not _update(Node, _field(FieldName, FieldValue), S).


% 						### Introducing facts
%--------------------------------------------------------------------------------
% Note: to update a field means to remove old field and add the new field value
_holds(Node, _field(FieldName, FieldValue), S+1) 	:-	_introduce(Node, _field(FieldName, FieldValue), S),
														_step(S+1).
_holds(Node, _field(FieldName, FieldValue), S+1) 	:-	_update(Node, _field(FieldName, FieldValue), S),
														_step(S+1).

				%selecting rules
% select no more than one action per step
{ _doAction(Action, S) : _applicable(Action, S) } 1 :- _step(S).
:- _step(S), 2 { _doAction(_action(Name, Data), S) : _action(Name, Data) }.
% NOTE: polynomial rules can instantiate a _doAction() to force next action in a sequence of steps

				% ensure all steps are done first
_actionForStep(S) :- _doAction(Action,S).
:- _step(S), _step(S+1), not _actionForStep(S), _actionForStep(S+1).

% TODO: delete later, only for debugging
#show _active/1.
%#show _numChildren/2.
%#show _root/1.

% needed for visualizer
#show _activeChild/2.
#show _nodeType/2.
#show _monomOf/3.
#show _nodeOper/2.
#show _holds/3.
